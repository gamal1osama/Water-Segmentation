<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Analysis Results | HydroSeg</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Generating water analysis...</p>
    </div>

    <div class="container">
        <header class="text-center">
            <h1><i class="fas fa-water"></i> HydroSeg Analysis Report</h1>
        </header>

        <div class="results-grid">
            <!-- Original Image -->
            <div class="card">
                <div class="card-content">
                    <h2><i class="fas fa-satellite"></i> Original Image</h2>
                    <div class="image-wrapper">
                        <img src="{{ url_for('static', filename='rgb.png') }}?t={{ timestamp }}" 
                             alt="Original satellite image"
                             id="original-img">
                    </div>
                </div>
            </div>

            <!-- Water Mask -->
            <div class="card">
                <div class="card-content">
                    <h2><i class="fas fa-map-marked-alt"></i> Water Detection</h2>
                    <div class="image-wrapper">
                        <img src="{{ url_for('static', filename='pred_mask.png') }}?t={{ timestamp }}" 
                             alt="Water mask prediction"
                             id="mask-img">
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Analysis Summary -->
        <div class="card analysis-summary">
            <div class="card-content">
                <h2><i class="fas fa-chart-bar"></i> Quantitative Analysis</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="metric-value">{{ water_area }}</div>
                        <div class="metric-label">Water Surface Area</div>
                    </div>
                    <div class="metric">
                        <div class="metric-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="metric-value">{{ water_percent }}</div>
                        <div class="metric-label">Image Coverage</div>
                    </div>
                    <div class="metric">
                        <div class="metric-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="metric-value">Instant</div>
                        <div class="metric-label">Processing Time</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a href="/" class="btn btn-primary">
                <i class="fas fa-redo"></i> Analyze Another
            </a>
            <button class="btn" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button class="btn" id="download-btn">
                <i class="fas fa-download"></i> Export Data
            </button>
        </div>
    </div>

    <script>
        // Combined script section
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 1000);

            // Image error handling
            document.getElementById('original-img').onerror = function() {
                this.src = "{{ url_for('static', filename='image_error.png') }}";
                this.alt = "Error loading original image";
            };
            
            document.getElementById('mask-img').onerror = function() {
                this.src = "{{ url_for('static', filename='image_error.png') }}";
                this.alt = "Error loading water mask";
            };

            // Export functionality
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    // Show loading state
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                    this.classList.add('btn-loading');
                    
                    // Get current analysis values
                    const waterArea = document.querySelector('.metrics-grid .metric:nth-child(1) .metric-value').textContent;
                    const waterPercent = document.querySelector('.metrics-grid .metric:nth-child(2) .metric-value').textContent;
                    
                    // Trigger download
                    fetch(`/export?water_area=${encodeURIComponent(waterArea)}&water_percent=${encodeURIComponent(waterPercent)}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Export failed');
                            return response.blob();
                        })
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'hydroseg_analysis.zip';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        })
                        .catch(() => {
                            alert('Export failed. Please try again.');
                        })
                        .finally(() => {
                            this.innerHTML = originalText;
                            this.classList.remove('btn-loading');
                        });
                });
            }
        });
    </script>

    <footer class="mt-3 text-center">
        <p>HydroSeg Water Analysis System</p>
    </footer>
</body>
</html>